$(document).ready(function(){function t(e){function o(){var t=n.getContext("2d");t.drawImage(m,0,0,f,l);t.globalAlpha=.8;t.lineWidth=2;t.beginPath();t.rect(0,0,n.width,n.height);t.fillStyle="transparent";t.fill();t.strokeStyle="#888";t.stroke();if(!s){return}t.beginPath();t.strokeStyle="#000";var r=s.edges,i=r.length,o,u;while(i--){o=r[i];u=o.va;t.moveTo(u.x,u.y);u=o.vb;t.lineTo(u.x,u.y)}t.stroke();t.beginPath();t.fillStyle="blue";var a=s.vertices,c=a.length;while(c--){u=a[c];t.rect(u.x-3,u.y-3,5,5)}t.fill();t.beginPath();t.fillStyle="red";var h=e.length;while(h--){u=e[h];t.rect(u.x-2/3,u.y-2/3,5,5)}t.fill()}function u(){$.each(s.cells,function(e,n){function u(e,t,n){e.push(t);e.push(n)}var r=$(n)["0"].halfedges;var i,s=r.length;var o=[];for(i=0;i<s-1;i++){var a=Math.floor(r[""+i]["edge"]["va"]["x"]);var f=Math.floor(r[""+i]["edge"]["va"]["y"]);var l=Math.floor(r[""+i]["edge"]["vb"]["x"]);var c=Math.floor(r[""+i]["edge"]["vb"]["y"]);var h=Math.floor(r[""+(i+1)]["edge"]["va"]["x"]);var p=Math.floor(r[""+(i+1)]["edge"]["va"]["y"]);var d=Math.floor(r[""+(i+1)]["edge"]["vb"]["x"]);var v=Math.floor(r[""+(i+1)]["edge"]["vb"]["y"]);if(a==h&&f==p){u(o,l,c)}else{if(a==d&&f==v){u(o,l,c)}else{if(l==h&&c==p){u(o,a,f)}else{u(o,a,f)}}}}var a=Math.floor(r["0"]["edge"]["va"]["x"]);var f=Math.floor(r["0"]["edge"]["va"]["y"]);var l=Math.floor(r["0"]["edge"]["vb"]["x"]);var c=Math.floor(r["0"]["edge"]["vb"]["y"]);var h=Math.floor(r[""+i]["edge"]["va"]["x"]);var p=Math.floor(r[""+i]["edge"]["va"]["y"]);var d=Math.floor(r[""+i]["edge"]["vb"]["x"]);var v=Math.floor(r[""+i]["edge"]["vb"]["y"]);if(a==h&&f==p){u(o,d,v)}else{if(a==d&&f==v){u(o,h,p)}else{if(l==h&&c==p){u(o,d,v)}else{u(o,h,p)}}}t["part"+(e+1)]=o});return t}var t={};var n=document.getElementById("voronoiCanvas");$(n).attr("width",""+f).attr("height",""+l);n.width=n.width;var r=new Voronoi;var i={xl:0,xr:f,yt:0,yb:l};var s=r.compute(e,i);o();var a=u();return a}function n(t,n,r,i,s,u,a){function f(e,t){var n="";var r={};var i=0;var s=0;for(var o in e){s++}for(var o in e){r[o]=new Image;r[o].onload=function(){if(++i>=s){t(r)}};r[o].src=n+e[o]}}function l(e,t){var n=e;var r=t;var i=n.getX();var s=n.getY();if(i>r.x-450&&i<r.x+450&&s>r.y-450&&s<r.y+450){return true}else{return false}}function d(e){for(key in e){e[key].hide()}}function v(o){function x(e,t){function n(e){var t=e.length,n,r;while(0!==t){r=Math.floor(Math.random()*t);t-=1;n=e[t];e[t]=e[r];e[r]=n}return e}function r(e,r){function i(e){for(var t=0,n=e.length;t<n;t++){if(e[t].noFit)return false}return true}var s=[];var o=0;for(var u in t){s[o]={w:t[u].width,h:t[u].height,topLeft:t[u].topLeft,blockKey:u+""};o++}n(s);var a=new NETXUS.RectanglePacker(e.packerWidth,e.packerHeight);var f;for(var l=0;l<s.length;l++){f=a.findCoords(s[l].w,s[l].h);s[l].fit={};if(f){s[l].fit.x=f.x;s[l].fit.y=f.y}else{s[l].noFit=true}}var c=[];for(var h in s){c[h]={w:s[h].w,h:s[h].h};c[h].fit={};c[h].noFit=s[h].noFit}while(i(c)){a=new NETXUS.RectanglePacker(e.packerWidth,e.packerHeight);r.marginX+=5;r.marginY+=5;for(var p in c){s[p].fit.x=c[p].fit.x;s[p].fit.y=c[p].fit.y;s[p].noFit=c[p].noFit}for(var d=0;d<c.length;d++){f=a.findCoords(c[d].w+r.marginX,c[d].h+r.marginY);c[d].noFit=false;if(f){c[d].fit.x=f.x;c[d].fit.y=f.y}else{c[d].noFit=true}}}if(!i(s))alert("Some block has noFit = true");return s}var o={marginX:0,marginY:0};var f=50,l=50,c=20;h=s-a-f+c;p=i/2-u/2;var v=h-f*2,m=i-l*2;var g={white_coords:{x:h,y:p}};var b={};var w={offsetY:l,offsetX:f};y=new Kinetic.Rect({width:v+c,height:m+c,x:f-c/2,y:l-c/2,opacity:.3,fill:"blue",stroke:"black",strokeWidth:c});d.add(y);var E={packerWidth:v,packerHeight:m};var S=r(E,o);for(var x=0,T=S.length;x<T;x++){var C=S[x].blockKey;b[C]={};b[C].x=S[x].fit.x-S[x].topLeft.x+o.marginX/2+w.offsetX;b[C].y=S[x].fit.y-S[x].topLeft.y+o.marginY/2+w.offsetY}for(N in e){g[N+"_coords"]={};g[N+"_coords"].x=h;g[N+"_coords"].y=p}return{out1:g,out2:b}}function T(e){return function(e){b={};var t,n=m.width,r=m.height;var i=document.getElementById("calculatePositionsLayer");$(i).attr("width",n);$(i).attr("height",r);var s=i.getContext("2d");for(var u in e){s.clearRect(0,0,n,r);s.drawImage(o[u],0,0);b[u]={top:{},bottom:{},left:{},right:{}};t=s.getImageData(0,0,n,r).data;var a,f;for(var l=0,c=t.length;l<c;l+=4){if(t[l+3]!=0){f=Math.floor(l/(4*n));a=l/4-f*n;b[u].top.x=a;b[u].top.y=f;break}}for(var h=t.length-4;h>0;h-=4){if(t[h+3]!=0){f=Math.floor(h/(4*n));a=h/4-f*n;b[u].bottom.x=a;b[u].bottom.y=f;break}}e:for(var p=0;p<n;p++){for(var d=0;d<r;d++){if(t[(n*d+p)*4+3]!=0){b[u].left.x=p;b[u].left.y=d;break e}}}t:for(var v=n-1;v>=0;v--){for(var g=r-1;g>=0;g--){if(t[(n*g+v)*4+3]!=0){b[u].right.x=v;b[u].right.y=g;break t}}}var y=b[u];y.topLeft={x:y.left.x,y:y.top.y};y.width=y.right.x-y.left.x;y.height=y.bottom.y-y.top.y}$(i).remove();return b}(e)}var f=t;var d=new Kinetic.Layer;var v=n;var g=0;var y;var b=T(c);var w=x(c,b);var E=w.out1;var S=w.out2;for(var N in S){(function(){var t=N;var n=S[N];var i=new Kinetic.Image({image:o[N],x:n.x,y:n.y,draggable:true,brightness:0,blurRadius:0});i.cache();i.drawHitFromCache();i.filters([Kinetic.Filters.Blur,Kinetic.Filters.Brighten]);i.on("dragstart",function(){v.moveToTop();this.moveToTop();d.draw()});i.on("dragend",function(){var n=E[t+"_coords"];if(!i.inRightPlace&&l(i,n)){r[t].offsetX(-h);r[t].offsetY(-p);r[t].show();v.draw();i.setPosition({x:n.x,y:n.y});d.draw();i.inRightPlace=true;if(++g>=Object.keys(o).length-1){y.destroy();$("body").css({background:'url("../images/congratulations.jpg")',backgroundSize:"contain center center"});setTimeout(function(){document.location.href=document.location.origin+"/BunnyFinal/html/"+localStorage.getItem("environment")+"Environment.html?"+e},3e3)}setTimeout(function(){i.setDraggable(false);r[t].setDraggable(false)},50)}});i.on("mouseover touchstart",function(){i.blurRadius(1);i.brightness(.3);d.draw();document.body.style.cursor="pointer"});i.on("mouseout touchend",function(){i.blurRadius(0);i.brightness(0);d.draw();document.body.style.cursor="default"});i.on("dragmove",function(){document.body.style.cursor="pointer"});d.add(i)})()}var C=o["white_coords"];var k=E["white_coords"];var L=new Kinetic.Image({image:C,width:a,height:u,x:k.x,y:k.y});d.add(L);f.add(d)}f(o,v)}function r(e,t,r,s,a){function h(p,d){return function(h){var d=new Kinetic.Line({points:p,fillPatternImage:m,fillPatternScale:{x:m.width/int.width,y:m.height/int.height},fillPatternOffset:{x:0,y:0},closed:true,draggable:true});c.add(d);i(d);c.add(d);u["part"+h]=d;d.toImage({width:a,height:s,quality:1,callback:function(i){f["part"+h]=i.src;$.extend(o,f);c.draw();if(Object.keys(o).length==1+Object.keys(e).length){n(l,c,u,t,r,s,a)}}});d.hide()}(h.counter++)}var f={};var l=new Kinetic.Stage({x:0,y:0,container:"container2",width:$(window).width()-4.5,height:$(window).height()-4.5});var c=new Kinetic.Layer({});h.counter=1;$.each(e,function(e,t){h(t,e)});l.add(c)}function i(e){var t=e.getWidth();var n=e.getHeight();var r=e.getContext();var i=r.getImageData(0,0,l,f);var s=i.data;for(var o=0,u=s.length;o<u;o+=4){if(s[o+3]!=0){s[o+3]=255}}r.putImageData(i,0,0)}function s(e,t){$.each(e,function(e,n){n.x*=$(window).width()/t.width;n.y*=$(window).height()/t.height})}var e=document.location.search.slice(14);console.log(e);var o={};var u={};var a=0;var f;var l;var c;var h;var p;var d={width:1680,height:960};var v={"7.png":{easy:[{x:146,y:138,voronoiId:0},{x:197,y:323,voronoiId:9},{x:298,y:143,voronoiId:1},{x:314,y:246,voronoiId:5},{x:240,y:350,voronoiId:10},{x:213,y:213,voronoiId:3},{x:283.1294493768364,y:298.93184260092676,voronoiId:8},{x:426,y:399,voronoiId:11},{x:362,y:206,voronoiId:2},{x:269,y:255,voronoiId:6},{x:543.2589008677751,y:273.64585227239877,voronoiId:7},{x:351,y:215,voronoiId:4}]},"dolphin_big.png":{easy:[{x:161,y:190,voronoiId:1},{x:167,y:563,voronoiId:4},{x:354,y:200,voronoiId:2},{x:107,y:337,voronoiId:3},{x:365,y:73,voronoiId:0}],medium:[{x:193,y:205,voronoiId:3},{x:160,y:382,voronoiId:7},{x:195,y:577,voronoiId:9},{x:346,y:43,voronoiId:0},{x:339,y:215,voronoiId:4},{x:364.0158408503048,y:177.07813758775592,voronoiId:2},{x:215,y:217,voronoiId:5},{x:120.39007682469673,y:474.35512219229713,voronoiId:8},{x:124,y:315,voronoiId:6},{x:294,y:138,voronoiId:1}],hard:[{x:193,y:205,voronoiId:5},{x:160,y:382,voronoiId:11},{x:195,y:577,voronoiId:13},{x:346,y:43,voronoiId:0},{x:339,y:215,voronoiId:6},{x:364.0158408503048,y:177.07813758775592,voronoiId:4},{x:257,y:283,voronoiId:8},{x:120.39007682469673,y:474.35512219229713,voronoiId:12},{x:124,y:315,voronoiId:9},{x:294,y:138,voronoiId:3},{x:448,y:125,voronoiId:1},{x:180.37633684510365,y:348.2454774607904,voronoiId:10},{x:228,y:127,voronoiId:2},{x:90,y:228,voronoiId:7},{x:162,y:606,voronoiId:14}]}};var m=new Image;m.src="../images/"+e;m.onload=function(){int={};int.width=m.width;int.height=m.height;m.width=m.width/10;m.height=m.height/10;var n=.4;var i=2/10;var u=1/20;var a=$(window).width();var h=$(window).height();if(m.width>m.height){m.height=m.height*a*(n-u)/m.width;m.width=a*(n-u)}else{while(m.width<=a*n&&m.height<=h*(1-i)){m.width=m.width*(m.height+20)/m.height;m.height+=20}}l=m.height;f=m.width;var p=localStorage.getItem("level_word");s(v[e][p],d);window.coords=c=t(v[e][p]);o["white_coords"]="../images/coloredImage_"+e;$("#voronoiCanvas").remove();r(c,h,a,l,f);$(".menuButton").remove()}})